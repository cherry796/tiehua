<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>éé—æ‰“é“èŠ± AI ä½“éªŒ</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<style>
body{margin:0;background:#000;font-family:serif;overflow:hidden;position:relative}
#canvas,#v{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
#spoon,#flower{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;display:none;pointer-events:none}
#flower{width:300px;height:300px}
#txt{position:absolute;bottom:10%;left:50%;transform:translateX(-50%);width:80%;background:rgba(0,0,0,.7);color:#f90;border:1px solid #f90;border-radius:8px;padding:12px 16px;font-size:16px;text-align:center;display:none}
#end{position:absolute;inset:0;background:#000;color:#f90;display:none;flex-direction:column;align-items:center;justify-content:center;font-size:20px}
#end button{margin-top:20px;padding:8px 20px;font-size:16px;background:#f90;color:#000;border:none;border-radius:4px}
</style>
</head>
<body>
<!-- æ‘„åƒå¤´ -->
<video id="v" autoplay playsinline></video>
<canvas id="canvas" style="display:none"></canvas>

<!-- ç‰¹æ•ˆå…ƒç´  -->
<img id="spoon" src="https://cdn.jsdelivr.net/gh/zhaoolee/garss/imgs/spoon.png">
<img id="flower" src="https://cdn.jsdelivr.net/gh/zhaoolee/garss/imgs/flower.gif">

<!-- æ–‡æ¡ˆå¼¹çª— -->
<div id="txt"></div>

<!-- å°¾é¡µ -->
<div id="end">
  <div>ğŸ‰ ä½“éªŒå®Œæˆï¼ä½ å·²æŒæ¡æ‰“é“èŠ±æ ¸å¿ƒæŠ€å·§</div>
  <button onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.min.js"></script>
<script>
const v   = document.getElementById('v');
const ctx = document.getElementById('canvas').getContext('2d');
const spoon  = document.getElementById('spoon');
const flower = document.getElementById('flower');
const txt    = document.getElementById('txt');
const end    = document.getElementById('end');

const FIST_TH  = 0.03;
const LIFT_TH  = 0.08;
const TIME_WIN = 800;

let lastWy = -1, lastTime = 0;
const tips=[8,12,16,20], bases=[5,9,13,17];

/* æ–‡æ¡ˆåº“ */
const words = {
  fist: 'æ¡æ‹³å³æ¡å‹ºï¼šæŸ³æœ¨å‹ºéœ€æµ¸æ°´é˜²æ½®ï¼Œæ–¹èƒ½ç››èµ·1600â„ƒé“æ°´ï¼',
  lift: 'æ‰¬è‡‚é£èŠ±ï¼šé“æ°´æ’å‡»ç©ºæ°”ç¬é—´æ°§åŒ–ï¼Œä¸‡ç‚¹é‡‘æ˜Ÿç»½æ”¾ï¼'
};

/* é€šç”¨ 2s å¼¹çª— + å›è°ƒ */
function showTxt(type, cb){
  txt.textContent = words[type];
  txt.style.display = 'block';
  setTimeout(()=>{
    txt.style.display='none';
    cb && cb();
  },2000);
}

/* ç»“æŸä½“éªŒ */
function goEnd(){
  v.style.display='none';          // å…³æ‘„åƒç”»é¢
  flower.style.display='none';
  spoon.style.display='none';
  end.style.display='flex';        // æ˜¾ç¤ºå°¾é¡µ
}

/* æ¯å¸§å›è°ƒ */
function onResults(res){
  if(res.multiHandLandmarks && res.multiHandLandmarks.length){
    const lm = res.multiHandLandmarks[0];
    const now = performance.now();

    /* 1. æ¡æ‹³ -> æœ¨å‹º + æŒ‡ç¤ºæ–‡æ¡ˆï¼ˆä»…ä¸€æ¬¡ï¼‰ */
    const fist = tips.every(i=>lm[i].y > lm[bases[tips.indexOf(i)]].y + FIST_TH);
    if(fist && !spoon._shown){          // _shown è‡ªåˆ¶æ ‡å¿—ä½
      spoon.style.display = 'block';
      spoon._shown = true;
      showTxt('fist');
    }else if(!fist){
      spoon.style.display = 'none';
    }

    /* 2. æŠ¬æ‰‹ -> é“èŠ± + çŸ¥è¯†ç‚¹ -> ç»“æŸä½“éªŒ */
    const wy = lm[0].y;
    if(lastWy>=0){
      const dy = Math.abs(wy - lastWy);
      if(dy > LIFT_TH && now - lastTime < TIME_WIN){
        flower.style.display = 'block';
        showTxt('lift',()=>{
          // çŸ¥è¯†ç‚¹å¼¹å®Œ â†’ 3 ç§’åç»“æŸ
          setTimeout(goEnd,3000);
        });
        lastWy = -1; // é˜²æ­¢é‡å¤è§¦å‘
      }
    }
    lastWy = wy; lastTime = now;
  }else{
    lastWy = -1;
  }
}

/* MediaPipe åˆå§‹åŒ– */
const hands = new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`});
hands.setOptions({maxNumHands:1, modelComplexity:0, minDetectionConfidence:0.7});
hands.onResults(onResults);

/* å¼€æ‘„åƒå¤´ */
navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}})
  .then(stream=>{
    v.srcObject = stream;
    v.onloadedmetadata=()=>{
      const cam = new Camera(v,{onFrame:async()=>await hands.send({image:v}),width:v.videoWidth,height:v.videoHeight});
      cam.start();
    };
  })
  .catch(err=>alert('æ‘„åƒå¤´æƒé™å¤±è´¥ï¼š'+err));
</script>
</body>
</html>